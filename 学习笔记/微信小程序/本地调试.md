首先打开容器，在容器名字上单击鼠标右键，选择`Attach Weixin Devtools`就能开启微信开发者工具中的本地调试。

![QQ截图20240630100658](./QQ截图20240630100658.png)



使用本地调试时,微信小程序开发者工具中，在`wx.cloud.callcontainer`的头部配置中，`X-WX-SERVICE`中设置为本地容器的名字，不再使用云端的容器的名字，就能实现在本地调试。

![QQ截图20240629182015](./QQ截图20240629182015.png)

向本地调试的服务器发送数据，不需要使用`http://127.0.0.1:40461/user/register`完整域名，只需要使用`/user/register`就行。



![QQ截图20240630095950](./QQ截图20240630095950.png)

> ### 本地调试特别注意事项
>
> 记得启动云端数据库，再启动`vps`中的`MySQL`代理服务，虽然是本地调试，但是数据还是写到云端数据库的。使用`vscode`中`MySQL`插件连接一下数据库就能启动云端的数据库，等等其他方法。
>

连接不上数据库的原因，经过测试，和`v2ray`是是否开启代理无关。

`vscode`中的容器，`start`是启动的普通容器，不会监听代码变更而实时更新，`live coding`会实时监听代码变更而实时更新服务器，因而无需频繁的使用docker build重新构建容器，这比启动普通的容器方便多了。

![QQ截图20240630104837](./QQ截图20240630104837.png)

仔细观察,会发嵌套了两层，有两层框架，这就为什么会实时更新的原因了，不过也更耗CPU了。

![QQ截图20240630105347](./QQ截图20240630105347.png)

 内网地址`  "domain": "eoixleqv.koa-q901.4om1h0kq.3kgaaf8f.com",`测试这个配置是否对连接数据库的影响。

经测试对数据库的连接是毫无影响的。







`请解释一下`:

```sh
正在执行任务: docker run  --rm -d --network wxcb0 --ip [10.2.114.172](http://10.2.114.172) --pull=always -e TOAL_ROLE=client -e TOAL_SERVER=https://wxcloud-localdebug-proxy-109508-4-1326387808.sh.run.tcloudbase.com:443 -e TOAL_KEY=TOAL_bmfd2y2j7tq -e TOAL_SERVER_TIMEOUT=200 -e TOAL_MODE=shortpoll -e TOAL_LOCAL_PORT=3306 -e TOAL_TARGET=[10.2.114.172:3306](http://10.2.114.172:3306) -e TOAL_VERBOSE=DEBUG -l role=vpcdebugproxy -l wxcloud=[10.2.114.172:3306](http://10.2.114.172:3306) -l ip=[10.2.114.172](http://10.2.114.172) [ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest](http://ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest)  latest: Pulling from tcb_prd/wxcloud-localdebug-proxy Digest: sha256:e163e4a90d4a56094e6f6e28485d1479d0e91bb3a6291dd322774a0f01fc4332 Status: Image is up to date for [ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest](http://ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest) 3f85263dd22cca54dcf0ee39d34e4dc434fbe427f53d350a44c34af7362f5d2e *  终端将被任务重用，按任意键关闭。   *  正在执行任务: docker run  --rm -d --network wxcb0 --name [api.weixin.qq.com](http://api.weixin.qq.com) --pull=always -e TOAL_ROLE=client -e TOAL_SERVER=https://wxcloud-localdebug-proxy-109508-4-1326387808.sh.run.tcloudbase.com:443 -e TOAL_KEY=TOAL_bmfd2y2j7tq -e TOAL_SERVER_TIMEOUT=200 -e TOAL_MODE=shortpoll -e TOAL_LOCAL_PORT=80 -e TOAL_TARGET=[api.weixin.qq.com](http://api.weixin.qq.com) -e TOAL_VERBOSE=DEBUG -l role=vpcdebugproxy -l wxcloud=[api.weixin.qq.com](http://api.weixin.qq.com) -l domain=[api.weixin.qq.com](http://api.weixin.qq.com) [ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest](http://ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest)  latest: Pulling from tcb_prd/wxcloud-localdebug-proxy Digest: sha256:e163e4a90d4a56094e6f6e28485d1479d0e91bb3a6291dd322774a0f01fc4332 Status: Image is up to date for [ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest](http://ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest) 23fb59421904e78b1f04b29a9f338ab3965aa1c6381115afd377066780d3e563 *  终端将被任务重用，按任意键关闭。
```



这段输出显示了两个正在执行的 `docker run` 命令，它们分别启动了两个Docker容器，用于本地调试和连接腾讯云内网资源。以下是对这段输出的详细解释：

```sh
docker run --rm -d --network wxcb0 --ip 10.2.114.172 --pull=always -e TOAL_ROLE=client -e TOAL_SERVER=https://wxcloud-localdebug-proxy-109508-4-1326387808.sh.run.tcloudbase.com:443 -e TOAL_KEY=TOAL_bmfd2y2j7tq -e TOAL_SERVER_TIMEOUT=200 -e TOAL_MODE=shortpoll -e TOAL_LOCAL_PORT=3306 -e TOAL_TARGET=10.2.114.172:3306 -e TOAL_VERBOSE=DEBUG -l role=vpcdebugproxy -l wxcloud=10.2.114.172:3306 -l ip=10.2.114.172 ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest
```

\#### 参数解释：

- `--rm`：容器退出后自动删除。

- `-d`：以守护进程模式运行容器。

- `--network wxcb0`：指定容器使用的网络为 `wxcb0`。

- `--ip 10.2.114.172`：指定容器的IP地址为 `10.2.114.172`。

- `--pull=always`：总是拉取最新的镜像版本。

- `-e TOAL_ROLE=client`：设置环境变量 `TOAL_ROLE` 为 `client`。

- `-e TOAL_SERVER=https://wxcloud-localdebug-proxy-109508-4-1326387808.sh.run.tcloudbase.com:443`：设置环境变量 `TOAL_SERVER` 为指定的服务器地址。

- `-e TOAL_KEY=TOAL_bmfd2y2j7tq`：设置环境变量 `TOAL_KEY` 为指定的密钥。

- `-e TOAL_SERVER_TIMEOUT=200`：设置环境变量 `TOAL_SERVER_TIMEOUT` 为 200 毫秒。

- `-e TOAL_MODE=shortpoll`：设置环境变量 `TOAL_MODE` 为 `shortpoll` 模式。

- `-e TOAL_LOCAL_PORT=3306`：设置环境变量 `TOAL_LOCAL_PORT` 为 3306。

- `-e TOAL_TARGET=10.2.114.172:3306`：设置环境变量 `TOAL_TARGET` 为 `10.2.114.172:3306`。

- `-e TOAL_VERBOSE=DEBUG`：设置环境变量 `TOAL_VERBOSE` 为 `DEBUG`，启用调试日志。

- `-l role=vpcdebugproxy`：设置标签 `role` 为 `vpcdebugproxy`。

- `-l wxcloud=10.2.114.172:3306`：设置标签 `wxcloud` 为 `10.2.114.172:3306`。

- `-l ip=10.2.114.172`：设置标签 `ip` 为 `10.2.114.172`。

- `ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest`：使用腾讯云镜像仓库中的 `wxcloud-localdebug-proxy` 镜像的最新版本。

\### 第二条 `docker run` 命令

```shell
docker run --rm -d --network wxcb0 --name api.weixin.qq.com --pull=always -e TOAL_ROLE=client -e TOAL_SERVER=https://wxcloud-localdebug-proxy-109508-4-1326387808.sh.run.tcloudbase.com:443 -e TOAL_KEY=TOAL_bmfd2y2j7tq -e TOAL_SERVER_TIMEOUT=200 -e TOAL_MODE=shortpoll -e TOAL_LOCAL_PORT=80 -e TOAL_TARGET=api.weixin.qq.com -e TOAL_VERBOSE=DEBUG -l role=vpcdebugproxy -l wxcloud=api.weixin.qq.com -l domain=api.weixin.qq.com ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest
```

\#### 参数解释：

- `--rm`：容器退出后自动删除。

- `-d`：以守护进程模式运行容器。

- `--network wxcb0`：指定容器使用的网络为 `wxcb0`。

- `--name api.weixin.qq.com`：指定容器的名称为 `api.weixin.qq.com`。

- `--pull=always`：总是拉取最新的镜像版本。

- `-e TOAL_ROLE=client`：设置环境变量 `TOAL_ROLE` 为 `client`。

- `-e TOAL_SERVER=

  https://wxcloud-localdebug-proxy-109508-4-1326387808.sh.run.tcloudbase.com:443

  `

  ：设置环境变量 `TOAL_SERVER` 为指定的服务器地址。

- `-e TOAL_KEY=TOAL_bmfd2y2j7tq`：设置环境变量 `TOAL_KEY` 为指定的密钥。

- `-e TOAL_SERVER_TIMEOUT=200`：设置环境变量 `TOAL_SERVER_TIMEOUT` 为 200 毫秒。

- `-e TOAL_MODE=shortpoll`：设置环境变量 `TOAL_MODE` 为 `shortpoll` 模式。

- `-e TOAL_LOCAL_PORT=80`：设置环境变量 `TOAL_LOCAL_PORT` 为 80。

- `-e TOAL_TARGET=api.weixin.qq.com`：设置环境变量 `TOAL_TARGET` 为 `api.weixin.qq.com`。

- `-e TOAL_VERBOSE=DEBUG`：设置环境变量 `TOAL_VERBOSE` 为 `DEBUG`，启用调试日志。

- `-l role=vpcdebugproxy`：设置标签 `role` 为 `vpcdebugproxy`。

- `-l wxcloud=api.weixin.qq.com`：设置标签 `wxcloud` 为 `api.weixin.qq.com`。

- `-l domain=api.weixin.qq.com`：设置标签 `domain` 为 `api.weixin.qq.com`。

- `ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest`：使用腾讯云镜像仓库中的 `wxcloud-localdebug-proxy` 镜像的最新版本。

\### 总结
这两个 `docker run` 命令启动了两个容器，它们分别用于本地调试并连接到腾讯云内网的不同资源。通过设置各种环境变量和标签，这些容器能够与腾讯云的本地调试代理进行通信，并且在调试过程中提供详细的日志信息（DEBUG模式）。



腾讯云本地调试vps连接MySQL，会把内网地址转换为外网地址，然后验证用户名和密码，对吗？

在腾讯云本地调试环境中，通过VPC连接内网MySQL时，确实涉及到一些网络和身份验证的转换和处理。以下是详细的解释：

\### 1. 内网地址和外网地址的转换
在本地调试环境中，通常会通过一个代理或隧道将本地请求转发到云上的内网资源。这意味着：

- 本地请求：你在本地开发环境中发出的请求会被代理或隧道捕获。

- 代理转发：代理会将这些请求转发到云上的内网资源（如MySQL实例）。

- 内网访问：在云上，代理会使用内网地址访问MySQL。

\### 2. 用户名和密码验证
当请求到达MySQL实例时，MySQL会执行标准的身份验证过程：

- 接收请求：MySQL实例接收到来自代理的连接请求。

- 验证用户：MySQL实例会根据请求中的用户名和密码进行验证。

- 授权检查：MySQL会检查该用户是否有权限访问请求的数据库和表。

\### 具体流程
以下是一个简化的流程图，描述了本地调试环境中通过VPC连接MySQL的过程：

1. 本地开发环境：

- 你在本地代码中配置了MySQL的连接信息（如内网IP地址、端口、用户名和密码）。

- 你启动调试代理（如Docker容器），该代理配置了相关的环境变量（如`TOAL_LOCAL_PORT`、`TOAL_TARGET`等）。

1. 代理捕获请求：

- 你在本地运行应用程序，应用程序尝试连接MySQL。

- 代理捕获到连接请求，并将其转发到云上的调试代理服务器。

1. 调试代理服务器：

- 调试代理服务器接收到请求，并根据配置将其转发到MySQL实例的内网地址。

1. MySQL实例：

- MySQL实例接收到来自调试代理服务器的请求。

- MySQL执行标准的身份验证过程，验证用户名和密码。

- 如果验证通过，MySQL允许连接并处理请求。

\### 配置示例
假设你在VSCode中进行调试，以下是一个配置示例：

\#### VSCode Launch Configuration

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Launch Program",
      "skipFiles": ["<node_internals>/**"],
      "program": "${workspaceFolder}/app.js",
      "env": {
        "TOAL_LOCAL_PORT": "3306",
        "TOAL_TARGET": "10.2.114.172:3306",
        "TOAL_VERBOSE": "DEBUG"
      },
      "runtimeExecutable": "npm",
      "runtimeArgs": ["run", "dev"]
    }
  ]
}
```

\#### Docker Run Command

```sh
docker run --rm -d --network wxcb0 --ip 10.2.114.172 --pull=always -e TOAL_ROLE=client -e TOAL_SERVER=https://wxcloud-localdebug-proxy-109508-4-1326387808.sh.run.tcloudbase.com:443 -e TOAL_KEY=TOAL_bmfd2y2j7tq -e TOAL_SERVER_TIMEOUT=200 -e TOAL_MODE=shortpoll -e TOAL_LOCAL_PORT=3306 -e TOAL_TARGET=10.2.114.172:3306 -e TOAL_VERBOSE=DEBUG -l role=vpcdebugproxy -l wxcloud=10.2.114.172:3306 -l ip=10.2.114.172 ccr.ccs.tencentyun.com/tcb_prd/wxcloud-localdebug-proxy:latest
```

\### 注意事项

- 安全组配置：确保MySQL实例的安全组配置允许来自代理的入站流量。

- 用户权限：确保MySQL用户有足够的权限，并且允许从代理的IP地址进行连接。

- 调试代理配置：确保调试代理的配置正确，特别是`TOAL_LOCAL_PORT`和`TOAL_TARGET`等环境变量。

\### 结论
在腾讯云本地调试环境中，通过VPC连接内网MySQL时，代理会将本地请求转发到云上的内网地址，然后MySQL实例会执行标准的用户名和密码验证过程。确保配置正确，可以顺利进行本地调试和连接。